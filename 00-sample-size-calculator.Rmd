---
title: "A/B Pre-test Sample Size"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    navbar:
      - { title: "Zion & Zion", href: "https://www.zionandzion.com/" }
    css: www/styles.css
    theme:
      version: 4
      bg: "white"
      fg: "#262829" 
      primary: "#48718f"
      navbar-bg: "#3ADAC6"
      base_font: 
        google: Roboto
      heading_font:
        google: Roboto
      code_font:
        google: 
          family: JetBrains Mono
          local: false
    orientation: rows
    vertical_layout: fill
  runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(broom)
library(showtext)
library(DT)
library(BayesFactor)


font_add_google("Roboto", "roboto")
```


Sidebar {.sidebar data-width="350" data-height="500"}
-----------------------------------------------------------------------

**Data input:**

```{r}

# Weekly traffic
numericInput("WeeklyTraffic", "Weekly Traffic", min = 100, max = 50000, 
             value = 10000)

numericInput("Baseline", "Baseline conversion rate %", min = 1, max = 50, 
             value = 5)

numericInput("SigLevel", "Significance level (α)", min = 1, max = 20, 
            value = 5)

numericInput("Power", "Statistical power (1 - β)", min = 1, max = 99, 
             value = 80)

# numericInput("MDE", "Minimum detectable threshold", min = 1, max = 50,
#              value = 20)



radioButtons("Test_type", "Test type:", c("Two-tailed" = "two.sided", "One-tailed" = "one.sided"), selected = "two.sided")

actionButton(inputId = "apply", label = "Apply", icon = icon("play-circle-fill"), 
             style = "color: #fff; background-color: #48718f; border-color: #48718f; font-family: roboto; font-size: 14px; font-weight: bold; line-height: 1.5; border-radius: 0.25rem; padding: 0.375rem 0.75rem; transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; cursor: pointer;  white-space: nowrap; vertical-align: middle; user-select: none; border: 1px solid transparent;")
```


```{r}
data1 <- eventReactive(eventExpr = input$apply,  valueExpr = {
  seq(input$WeeklyTraffic / 2, input$WeeklyTraffic / 2 * 8, by = input$WeeklyTraffic / 2) %>%
        map_df(~ power.prop.test(p1          = input$Baseline / 100,
                                 p2          = NULL, 
                                 n           = .x, 
                                 power       = input$Power / 100, 
                                 sig.level   = input$SigLevel / 100,
                                 alternative = input$Test_type) %>%
                   tidy()) %>%
        mutate(effect = p2 / p1 - 1,
               total  = n * 2,
               n      = n)
}, ignoreNULL = FALSE)

data <- eventReactive(eventExpr = input$apply, 
                      valueExpr = {
                        seq(input$WeeklyTraffic / 2, input$WeeklyTraffic / 2 * 8, by = input$WeeklyTraffic / 2) %>%
                          map_df(~ power.prop.test(
                                 p1          = input$Baseline / 100,
                                 p2          = NULL, 
                                 n           = .x, 
                                 power       = input$Power / 100, 
                                 sig.level   = input$SigLevel / 100,
                                 alternative = input$Test_type) %>%
                                   tidy()) %>%
                          mutate(effect = scales::percent(p2 / p1 - 1),
                                 total  = scales::comma(n * 2),
                                 n      = scales::comma(n))
                          # mutate(Weeks  = str_c(row_number(), " ", "Weeks")) |> 
                          # mutate(difference = abs(as.numeric(sub("%", "", effect)) - input$MDE))
                        },
                      ignoreNULL = FALSE)

# Select MDE closest to input
# mde_effect_selection <- eventReactive(eventExpr = input$apply, 
#                                        valueExpr = {
#                                          data() |> 
#                                            filter(effect <= input$MDE) |> 
#                                            slice_max(effect)
#                                        },
#                                        ignoreNULL = FALSE)

# mde_effect_selection <- eventReactive(
#   eventExpr = input$apply,
#   valueExpr = {
#     # Ensure the data is available and not empty
#     if (is.null(data()) || nrow(data()) == 0) {
#       return(NULL)
#     }
#     
#     # Convert effect to numeric for comparison
#     data_numeric_effect <- data() %>%
#       mutate(effect_numeric = as.numeric(sub("%", "", effect)))
# 
#     min_effect <- min(data_numeric_effect$effect_numeric, na.rm = TRUE)
#     
#     if (input$MDE <= min_effect) {
#       # Use slice_min if input$MDE is less than the smallest effect
#       result <- data_numeric_effect %>%
#         filter(effect_numeric <= min_effect) %>%
#         slice_min(order_by = effect_numeric, with_ties = FALSE)
#     } else {
#       # Filter data where effect is less than or equal to input$MDE
#       filtered_data <- data_numeric_effect %>%
#         filter(effect_numeric <= input$MDE)
#       
#       # Use slice_max on the filtered data
#       result <- filtered_data %>%
#         slice_max(order_by = effect_numeric, with_ties = FALSE)
#     }
#     
#     return(result)
#   },
#   ignoreNULL = FALSE
# )



```


Row
-----------------------------------------------------------------------

```{r}
DT::renderDataTable({
  data() |> 
     select(`A relative detectible MDE` = effect, 
                                 `With a sample size in each group of` = n,
                                 `And a total sample size of` = total)
}, selection = "single", class = "display nowrap compact", 
   filter = "none", rownames = TRUE, 
   options = list(
     dom = "t",
     paging = FALSE,
     ordering = FALSE,
     searching = FALSE,
     info = FALSE,
     columnDefs = list(list(className = "dt-center", targets = "_all"))
   ))
```


